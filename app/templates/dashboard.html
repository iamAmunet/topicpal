<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TopicPal - Research</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }
    body {
      display: flex;
      min-height: 100vh;
      background-color: #f5f5f5;
    }
    .sidebar {
      width: 220px;
      background-color: #222;
      color: #fff;
      display: flex;
      flex-direction: column;
      padding: 1rem;
    }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 2rem;
    }
    .sidebar h3 {
      margin: 1rem 0 0.5rem;
      font-size: 1.1rem;
    }
    .sidebar a, .sidebar button {
      color: #fff;
      text-decoration: none;
      padding: 0.7rem 1rem;
      margin-bottom: 0.5rem;
      border-radius: 4px;
      transition: background 0.2s;
      background: none;
      border: none;
      cursor: pointer;
      text-align: left;
    }
    .sidebar a:hover, .sidebar button:hover {
      background-color: #444;
    }
    .sidebar a.active {
      background-color: #ff6600;
    }
    .project-list {
      max-height: 300px;
      overflow-y: auto;
    }
    .project-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
    }
    .project-item button {
      font-size: 0.9rem;
    }
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .top-bar {
      width: 100%;
      background: #fff;
      padding: 1rem;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
    }
    .profile a img {
      height: 40px;
      border-radius: 50%;
    }
    .research-chat {
      flex: 1;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      transition: opacity 0.3s ease;
    }
    .chat-container {
      flex: 1;
      width: 100%;
      display: flex;
      flex-direction: column;
      background-color: #fff;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .chat-title {
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }
    .chat-box {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      background-color: #f0f0f0;
      border-radius: 6px;
      margin-bottom: 1rem;
    }
    .chat-input-area {
      display: flex;
      gap: 0.5rem;
    }
    .chat-input {
      flex: 1;
      padding: 0.5rem 0.8rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .chat-send-btn, .save-project-btn {
      padding: 0.5rem 1rem;
      border: none;
      background-color: #ff6600;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .chat-send-btn:hover, .save-project-btn:hover {
      background-color: #e65c00;
    }
    .step {
      display: none;
      flex-direction: column;
      margin-top: 2rem;
      padding: 2rem;
      transition: opacity 0.3s ease;
    }
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .tabs button {
      flex: 1;
      padding: 0.6rem 1rem;
      border: none;
      background-color: #ddd;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s, opacity 0.2s;
    }
    .tabs button:hover {
      background-color: #ccc;
    }
    .tabs button.active {
      background-color: #ff6600;
      color: #fff;
      font-weight: bold;
    }
    .tabs button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #tabContent {
      padding: 1rem;
      background-color: #fff;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .bookmark-btn {
      position: absolute;
      background: #ff6600;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 4px;
    }
    .loading {
      color: #666;
      font-style: italic;
      margin-bottom: 0.5rem;
    }
    .error {
      color: red;
      margin-bottom: 1rem;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #ff6600;
      color: #fff;
      padding: 10px;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .research-chat[style*="display: none"], .step[style*="display: none"] {
      opacity: 0;
    }
    .research-chat[style*="display: flex"], .step[style*="display: flex"] {
      opacity: 1;
    }
    .user-message {
      text-align: right;
      background-color: #ffe6cc;
      padding: 1rem 2rem;
      border-radius: 6px;
      margin: 0.5rem 0;
      margin-left: 80%;
      max-width: 80%;
      display: inline-block;
    }
    .bot-message {
      text-align: left;
      background-color: #e0e0e0;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      margin: 0.5rem 0;
      margin-right: 20%;
      max-width: 80%;
      display: inline-block;
    }
    .choose-subtopic {
      display: inline-block;
      margin: 0 0.2rem;
    }
    .view-scraped-data {
      color: #ff6600;
      text-decoration: underline;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>TopicPal</h2>
    <a href="#" id="researchLink">Research</a>
    <a href="#" id="newResearch">New Research</a>
    <a href="{{ url_for('main.bookmark') }}">Bookmark Work</a>
    <a href="#">Settings</a>
    <a href="{{ url_for('main.logout') }}" id="logoutLink">Logout</a>
    <h3>Project History</h3>
    <div class="project-list">
      {% for project in projects %}
        <div class="project-item">
          <button class="project-load" data-project-id="{{ project.id }}">{{ project.topic | truncate(20) }}</button>
          <span>{{ project.created_at.strftime('%Y-%m-%d') }}</span>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="main-content">
    <header class="top-bar">
      <div class="profile">
        <a href="#"><img src="{{ url_for('static', filename='profile_placeholder.png') }}" alt="profile"></a>
      </div>
    </header>

    <main class="research-chat">
      <div class="chat-container">
        <h2 class="chat-title">What would you like to research today?</h2>
        <div class="chat-box" id="chatBox"></div>
        <form class="chat-input-area" id="chatForm">
          <input type="text" id="chatInput" placeholder="Type your topic..." class="chat-input" />
          <button type="submit" class="chat-send-btn">Send</button>
        </form>
      </div>
    </main>

    <div class="step" id="step3">
      <h2>Research Workspace</h2>
      <p>Your topic: <span id="chosenTopic"></span></p>
      <p>Subtopic: <span id="chosenSubtopic"></span></p>
      <div class="tabs">
        <button data-tab="overview" class="active">Overview</button>
        <button data-tab="keypoints">Key Points</button>
        <button data-tab="deepdive">Deep Dive</button>
        <button data-tab="sources">Sources</button>
        <button data-tab="summary">Summary</button>
      </div>
      <div id="tabContent">
        <div id="overview"></div>
        Select a tab above to view content.
      </div>
      <button id="backButton">Back</button>
      <button id="saveProjectButton" class="save-project-btn">Save Project</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const chatForm = document.getElementById('chatForm');
      const chatBox = document.getElementById('chatBox');
      const step3Section = document.getElementById('step3');
      const chosenTopic = document.getElementById('chosenTopic');
      const chosenSubtopic = document.getElementById('chosenSubtopic');
      const tabContent = document.getElementById('tabContent');
      const overview = document.getElementById('overview');
      const tabs = document.querySelectorAll('.tabs button');
      const researchLink = document.getElementById('researchLink');
      const newResearchLink = document.getElementById('newResearch');
      const logoutLink = document.getElementById('logoutLink');
      const chatSection = document.querySelector('.research-chat');
      const backButton = document.getElementById('backButton');
      const saveProjectButton = document.getElementById('saveProjectButton');

      // Helper function to show error messages in chat
      function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.textContent = message;
        errorDiv.className = 'error bot-message';
        chatBox.appendChild(errorDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
        setTimeout(() => errorDiv.remove(), 5000);
      }

      // Helper function to show toast notifications
      function showToast(message) {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.className = 'toast';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      // Switch to tabs section
      function switchToTabs() {
        chatSection.style.display = 'none';
        step3Section.style.display = 'flex';
      }

      // Back to chat section
      function backToChat() {
        step3Section.style.display = 'none';
        chatSection.style.display = 'flex';
      }

      // Add view scraped data link to chat
      function addViewLink(subtopic) {
        const botMsg = document.createElement('div');
        botMsg.className = 'bot-message';
        botMsg.innerHTML = `Data gathered for "${subtopic}". <a href="#" class="view-scraped-data">View scraped data</a>`;
        chatBox.appendChild(botMsg);
        chatBox.scrollTop = chatBox.scrollHeight;

        botMsg.querySelector('.view-scraped-data').addEventListener('click', (ev) => {
          ev.preventDefault();
          switchToTabs();
          const activeTab = sessionStorage.getItem('activeTab') || 'overview';
          showTab(activeTab);
        });
      }

      // Load session data and restore UI state
      async function loadSessionData() {
        try {
          // Fetch session data from backend
          const res = await fetch('/get_session_data', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          if (!res.ok) throw new Error(`Session fetch failed: ${res.status}`);
          const sessionData = await res.json();
          console.log('Backend session data:', sessionData);

          // Update sessionStorage
          sessionStorage.setItem('current_topic', sessionData.current_topic || '');
          sessionStorage.setItem('chosen_subtopic', JSON.stringify(sessionData.chosen_subtopic || {}));

          // Always start in chat section
          chatSection.style.display = 'flex';
          step3Section.style.display = 'none';

          // Check if there's a valid research ID
          if (sessionData.chosen_subtopic && sessionData.chosen_subtopic.research_id) {
            const resResearch = await fetch(`/get_research/${sessionData.chosen_subtopic.research_id}`);
            if (!resResearch.ok) {
              console.error(`Research fetch failed: ${resResearch.status}`);
              throw new Error('Invalid research record');
            }
            const research = await resResearch.json();
            console.log('Research data:', research);

            // Update sessionStorage
            sessionStorage.setItem('current_topic', research.topic || '');
            sessionStorage.setItem('chosen_subtopic', JSON.stringify({ subtopic: research.subtopic, research_id: sessionData.chosen_subtopic.research_id }));
            sessionStorage.setItem('scraper_results', JSON.stringify(research.scraper_results || null));

            // Restore chat history
            chatBox.innerHTML = '';
            if (research.chat_history && research.chat_history.length) {
              research.chat_history.forEach(msg => {
                const msgDiv = document.createElement('div');
                if (msg.content.startsWith('Here are some subtopics:')) {
                  // Parse subtopics and render as clickable links
                  const subtopics = msg.content.replace('Here are some subtopics: ', '').split(', ');
                  msgDiv.className = 'bot-message';
                  msgDiv.innerHTML = `<strong>Here are some subtopics:</strong> ${subtopics.map((s, i) =>
                    `<a href="#" class="choose-subtopic" data-index="${i}">${s}</a>`).join(', ')}`;
                  chatBox.appendChild(msgDiv);

                  // Re-attach click handlers for subtopics
                  msgDiv.querySelectorAll('.choose-subtopic').forEach(link => {
                    link.addEventListener('click', async function (ev) {
                      ev.preventDefault();
                      link.style.pointerEvents = 'none';
                      link.style.opacity = '0.5';

                      const selectedSubtopic = subtopics[link.dataset.index];
                      const selectedMsg = document.createElement('div');
                      selectedMsg.textContent = `Selected subtopic: ${selectedSubtopic}`;
                      selectedMsg.className = 'bot-message';
                      chatBox.appendChild(selectedMsg);
                      chatBox.scrollTop = chatBox.scrollHeight;

                      const subLoadingMsg = document.createElement('div');
                      subLoadingMsg.textContent = 'Fetching research data...';
                      subLoadingMsg.className = 'loading bot-message';
                      chatBox.appendChild(subLoadingMsg);
                      chatBox.scrollTop = chatBox.scrollHeight;

                      try {
                        const resSub = await fetch('/get_subtopics', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ topic: research.topic })
                        });
                        if (!resSub.ok) throw new Error(`Subtopics fetch failed: ${resSub.status}`);
                        const dataSub = await resSub.json();
                        const searchTerms = dataSub.search_terms[selectedSubtopic] || [];

                        const rememberRes = await fetch('/remember_subtopic', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({ subtopic: selectedSubtopic, search_terms: searchTerms })
                        });
                        if (!rememberRes.ok) throw new Error(`remember_subtopic failed: ${rememberRes.status}`);

                        const payload = { subtopic: selectedSubtopic, search_terms: searchTerms };
                        const resScraper = await fetch('/run_scraper', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify(payload)
                        });
                        subLoadingMsg.remove();

                        if (!resScraper.ok) throw new Error(`Scraper failed: ${resScraper.status}`);
                        const dataScraper = await resScraper.json();

                        if (dataScraper.results) {
                          addViewLink(selectedSubtopic);
                          sessionStorage.setItem('scraper_results', JSON.stringify(dataScraper.results));
                          chosenTopic.textContent = research.topic;
                          chosenSubtopic.textContent = selectedSubtopic;
                        } else {
                          showError('No research results found.');
                        }
                      } catch (err) {
                        console.error('Error processing subtopic:', err);
                        showError('Error processing subtopic.');
                      } finally {
                        link.style.pointerEvents = 'auto';
                        link.style.opacity = '1';
                      }
                    });
                  });
                } else {
                  // Render other messages (user, selected subtopic, view link)
                  msgDiv.innerHTML = msg.content.includes('View scraped data') ?
                    `${msg.content.split('View scraped data')[0]}<a href="#" class="view-scraped-data">View scraped data</a>` :
                    msg.content;
                  msgDiv.className = msg.role === 'user' ? 'user-message' : 'bot-message';
                  chatBox.appendChild(msgDiv);

                  // Re-attach click handler for view link
                  if (msg.content.includes('View scraped data')) {
                    msgDiv.querySelector('.view-scraped-data').addEventListener('click', (ev) => {
                      ev.preventDefault();
                      switchToTabs();
                      const activeTab = sessionStorage.getItem('activeTab') || 'overview';
                      showTab(activeTab);
                    });
                  }
                }
              });
              chatBox.scrollTop = chatBox.scrollHeight;
            }

            // If scraper_results exist and no view link in chat, add it
            if (research.scraper_results && Object.keys(research.scraper_results).length > 0) {
              const lastMsg = chatBox.lastChild;
              if (!lastMsg || !lastMsg.innerHTML.includes('view-scraped-data')) {
                addViewLink(research.subtopic);
              }
            }
          } else {
            console.log('No chosen_subtopic, showing empty chat');
          }
        } catch (err) {
          console.error('Error loading session data:', err);
          showError('Failed to load research data.');
          chatSection.style.display = 'flex';
          step3Section.style.display = 'none';
        }
      }

      // Initial load
      loadSessionData();

      // Chat submit with loading feedback
      if (chatForm) {
        const chatInput = chatForm.querySelector('.chat-input');
        chatForm.addEventListener('submit', async function (e) {
          e.preventDefault();
          if (!chatInput?.value.trim()) return;

          const userText = chatInput.value.trim();
          const userMsg = document.createElement('div');
          userMsg.textContent = userText;
          userMsg.className = 'user-message';
          chatBox.appendChild(userMsg);

          const loadingMsg = document.createElement('div');
          loadingMsg.textContent = 'Processing...';
          loadingMsg.className = 'loading bot-message';
          chatBox.appendChild(loadingMsg);
          chatBox.scrollTop = chatBox.scrollHeight;

          chatInput.value = '';

          try {
            const resSub = await fetch('/get_subtopics', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ topic: userText })
            });
            loadingMsg.remove();

            if (!resSub.ok) {
              throw new Error(`Subtopics fetch failed: ${resSub.status}`);
            }
            const dataSub = await resSub.json();

            const botMsg = document.createElement('div');
            botMsg.className = 'bot-message';
            botMsg.innerHTML = `<strong>Here is what i could find, you can click on one of the links:</strong> ${dataSub.subtopics.map((s, i) =>
              `<a href="#" class="choose-subtopic" data-index="${i}">${s}</a>`).join(', ')}`;
            chatBox.appendChild(botMsg);

            botMsg.querySelectorAll('.choose-subtopic').forEach(link => {
              link.addEventListener('click', async function (ev) {
                ev.preventDefault();
                link.style.pointerEvents = 'none';
                link.style.opacity = '0.5';

                const selectedSubtopic = dataSub.subtopics[link.dataset.index];
                const selectedMsg = document.createElement('div');
                selectedMsg.textContent = `Selected subtopic: ${selectedSubtopic}`;
                selectedMsg.className = 'bot-message';
                chatBox.appendChild(selectedMsg);
                chatBox.scrollTop = chatBox.scrollHeight;

                const subLoadingMsg = document.createElement('div');
                subLoadingMsg.textContent = 'Fetching research data...';
                subLoadingMsg.className = 'loading bot-message';
                chatBox.appendChild(subLoadingMsg);
                chatBox.scrollTop = chatBox.scrollHeight;

                const searchTerms = dataSub.search_terms[selectedSubtopic] || [];

                try {
                  const rememberRes = await fetch('/remember_subtopic', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subtopic: selectedSubtopic, search_terms: searchTerms })
                  });
                  if (!rememberRes.ok) {
                    throw new Error(`remember_subtopic failed: ${rememberRes.status}`);
                  }
                  console.log('remember_subtopic response:', await rememberRes.json());

                  const payload = { subtopic: selectedSubtopic, search_terms: searchTerms };
                  console.log('Sending to /run_scraper:', payload);
                  const resScraper = await fetch('/run_scraper', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                  });
                  subLoadingMsg.remove();

                  if (!resScraper.ok) {
                    const text = await resScraper.text();
                    console.error('Server error:', resScraper.status, text.slice(0, 50));
                    throw new Error(`Server returned status ${resScraper.status}`);
                  }
                  const dataScraper = await resScraper.json();
                  console.log('Response data:', dataScraper);

                  if (dataScraper.results) {
                    // Do not switch to tabs; add view link
                    addViewLink(selectedSubtopic);
                    sessionStorage.setItem('scraper_results', JSON.stringify(dataScraper.results));
                    chosenTopic.textContent = userText;
                    chosenSubtopic.textContent = selectedSubtopic;
                  } else {
                    console.error(dataScraper.error || 'No results');
                    showError('No research results found.');
                  }
                } catch (err) {
                  console.error('Error running scraper:', err);
                  showError('Error processing subtopic.');
                } finally {
                  link.style.pointerEvents = 'auto';
                  link.style.opacity = '1';
                }
              });
            });

            chatBox.scrollTop = chatBox.scrollHeight;
          } catch (err) {
            console.error('Error fetching subtopics:', err);
            loadingMsg.remove();
            showError('Error retrieving subtopics from server.');
          }
        });
      }

      // Tab switching with loading feedback
      function showTab(tabName) {
        tabs.forEach(btn => {
          btn.classList.remove('active');
          btn.disabled = false;
        });
        const activeBtn = document.querySelector(`.tabs button[data-tab="${tabName}"]`);
        if (activeBtn) {
          activeBtn.classList.add('active');
          activeBtn.disabled = true;
        }

        tabContent.innerHTML = '<div class="loading">Loading data...</div>';
        sessionStorage.setItem('activeTab', tabName);

        function loadTabContent() {
          fetch(`/tab_content/${tabName}`)
            .then(res => {
              if (!res.ok) {
                return res.text().then(text => {
                  throw new Error(`Tab content fetch failed: ${res.status} ${text.slice(0, 50)}`);
                });
              }
              return res.json();
            })
            .then(data => {
              tabContent.innerHTML = '';
              if (data.content === 'Scraping in progress, please wait...') {
                const contentDiv = document.createElement('div');
                contentDiv.textContent = data.content;
                tabContent.appendChild(contentDiv);
                setTimeout(loadTabContent, 5000);
              } else {
                if (tabName === 'overview') {
                  overview.innerHTML = data.content;
                  tabContent.appendChild(overview);
                } else {
                  const contentDiv = document.createElement('div');
                  contentDiv.innerHTML = data.content;
                  tabContent.appendChild(contentDiv);
                }
              }
            })
            .catch(err => {
              console.error('Error loading tab:', err);
              tabContent.innerHTML = `<div class="error">Error loading ${tabName}</div>`;
            })
            .finally(() => {
              if (activeBtn) activeBtn.disabled = false;
            });
        }
        loadTabContent();
      }

      if (backButton) {
        backButton.addEventListener('click', backToChat);
      }

      tabs.forEach(tab => {
        tab.addEventListener('click', () => showTab(tab.dataset.tab));
      });

      // Bookmark feature with toast feedback
      tabContent.addEventListener('mouseup', (e) => {
        const selection = window.getSelection();
        if (selection.toString().trim()) {
          const existingBtn = document.querySelector('.bookmark-btn');
          if (existingBtn) existingBtn.remove();
          const bookmarkBtn = document.createElement('button');
          bookmarkBtn.textContent = 'Bookmark';
          bookmarkBtn.className = 'bookmark-btn';
          bookmarkBtn.style.left = `${e.pageX}px`;
          bookmarkBtn.style.top = `${e.pageY}px`;
          bookmarkBtn.onclick = () => {
            fetch('/bookmark', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ text: selection.toString().trim() })
            })
              .then(res => res.json())
              .then(data => {
                console.log('Bookmarked:', data);
                showToast('Text bookmarked!');
              })
              .catch(err => {
                console.error('Bookmark error:', err);
                showError('Failed to bookmark text.');
              });
            bookmarkBtn.remove();
          };
          document.body.appendChild(bookmarkBtn);
        }
      });

      document.addEventListener('click', (e) => {
        const bookmarkBtn = document.querySelector('.bookmark-btn');
        if (bookmarkBtn && !bookmarkBtn.contains(e.target)) {
          bookmarkBtn.remove();
        }
      });

      // Save project
      if (saveProjectButton) {
        saveProjectButton.addEventListener('click', async () => {
          try {
            const res = await fetch('/save_research', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();
            if (!res.ok) {
              console.error(`Save failed: ${data.error}`);
              showError(`Failed to save project: ${data.error}`);
              return;
            }
            showToast('Project saved!');
            // Refresh page to update history list
            window.location.reload();
          } catch (err) {
            console.error('Error saving project:', err);
            showError('Failed to save project.');
          }
        });
      }

      // Load project
      document.querySelectorAll('.project-load').forEach(btn => {
        btn.addEventListener('click', async () => {
          const projectId = btn.dataset.projectId;
          try {
            const res = await fetch(`/load_project/${projectId}`);
            if (!res.ok) throw new Error(`Load project failed: ${res.status}`);
            const data = await res.json();
            console.log('Loaded project:', data);
            chatBox.innerHTML = '';
            data.chat_history.forEach(msg => {
              const msgDiv = document.createElement('div');
              msgDiv.textContent = msg.content;
              msgDiv.className = msg.role === 'user' ? 'user-message' : 'bot-message';
              chatBox.appendChild(msgDiv);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
            chosenTopic.textContent = data.topic || '';
            chosenSubtopic.textContent = data.subtopic || '';
            overview.innerHTML = data.scraper_results ?
              `<ul>${Object.values(data.scraper_results).flatMap(query_results =>
                Object.values(query_results).flatMap(source_results =>
                  source_results.map(r => `<li><a href="${r.link}" target="_blank">${r.title}</a> (${r.source}): ${r.snippet.slice(0, 200)}</li>`)
                )).join('')}</ul>` : '';
            chatSection.style.display = 'flex';
            step3Section.style.display = 'none';
            // Add view link if scraper_results exist and not in chat
            const lastMsg = chatBox.lastChild;
            if (data.scraper_results && (!lastMsg || !lastMsg.innerHTML.includes('view-scraped-data'))) {
              addViewLink(data.subtopic);
            }
            showToast('Project loaded!');
          } catch (err) {
            console.error('Error loading project:', err);
            showError('Failed to load project.');
          }
        });
      });
    });
  </script>
</body>
</html>